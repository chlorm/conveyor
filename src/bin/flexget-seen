#!bash
# Copyright (c) 2017, Cody Opel <codyopel@gmail.com>
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Populates flexget's seen list from library.

# TODO: movie support

set -o errexit
set -o errtrace
set -o functrace
set -o nounset
set -o pipefail

PREFIX="$(readlink -f "$(readlink -f "$(dirname "$(readlink -f "$0")")")"/..)"
source "$PREFIX/share/conveyor/common.bash"

trap 'exit' ERR SIGINT SIGTERM

#MV_DIR="$RCLONE_REMOTE/$RCLONE_REMOTE_SORTED_DIR/movies"
TV_DIR="$RCLONE_REMOTE/$RCLONE_REMOTE_SORTED_DIR/television"

#mapfile -t MOVIE_SORT_DIRS < <(rc_lsd "$MV_DIR")
mapfile -t TELEVISION_SORT_DIRS < <(rc_lsd "$TV_DIR")

declare -a SHOWS_LIST=()
for sortchar in "${TELEVISION_SORT_DIRS[@]}"; do
  SHOW_LIST=()
  mapfile -t SHOW_LIST < <(rc_lsd "$TV_DIR/$sortchar")
  for show in "${SHOW_LIST[@]}"; do
    echo "show: $show" >&2
    SHOW_FILE_LIST=()
    mapfile -t SHOW_FILE_LIST < <(rc_ls "$TV_DIR/$sortchar/$show")
    for showfile in "${SHOW_FILE_LIST[@]}"; do
      if [[ "${showfile##*.}" == @(avi|mkv|mov|mp4|mpeg|mpg|mov|ts) ]]; then
        echo "file: $show/$showfile" >&2
        FileSanitized="$(echo "$show/$showfile" | sed -e 's/^-/\\-/')"
        Guessit="$(guessit_wrapper "$FileSanitized")"
        showtitle="$(guessit_title "$Guessit")"
        flexget series add "$showtitle" "$(basename "$showfile")"
      fi
    done
  done
done
